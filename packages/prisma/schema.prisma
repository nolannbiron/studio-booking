generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["fullTextSearch"]
}

// generator zod {
//     provider      = "zod-prisma"
//     output        = "./zod"
//     imports       = "./zod-utils"
//     relationModel = "default"
// }

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator enums {
    provider = "tsx ./enum-generator"
}

enum IdentityProvider {
    JWT
    GOOGLE
    GITHUB
}

enum Locale {
    fr
    en
}

model User {
    id            String    @id @default(uuid())
    firstName     String?
    lastName      String?
    fullName      String?
    avatarUrl     String?
    email         String    @unique
    password      String?
    locale        Locale?   @default(en)
    isRoot        Boolean   @default(false)
    avatarColor   String?
    /// @zod.custom(imports.userMetadata)
    metadata      Json?
    emailVerified DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    identityProvider   IdentityProvider @default(JWT)
    identityProviderId String?
    teams              Membership[]
    accounts           Account[]
    sessions           Session[]

    @@index([email, password])
    @@map("users")
}

model VerificationToken {
    id            Int      @id @default(autoincrement())
    identifier    String
    token         String   @unique
    expires       DateTime
    expiresInDays Int?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    team   Team?   @relation(fields: [teamId], references: [id])
    teamId String?

    @@unique([identifier, token])
    @@index([token])
    @@index([teamId])
    @@map("verification_tokens")
}

enum MembershipRole {
    MEMBER
    ADMIN
    OWNER
}

model Membership {
    id       String         @id @default(uuid())
    role     MembershipRole @default(MEMBER)
    accepted Boolean        @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
    teamId String

    @@unique([userId, teamId])
    @@index([userId])
    @@index([teamId])
    @@map("memberships")
}

model Team {
    id         String  @id @default(uuid())
    name       String
    slug       String  @unique
    websiteUrl String?
    logoUrl    String?
    /// @zod.custom(imports.teamMetadataSchema)
    metadata   Json?
    color      String?

    members Membership[]

    orgSettings OrganizationSettings?

    createdAt          DateTime            @default(now())
    updatedAt          DateTime            @updatedAt
    verificationTokens VerificationToken[]

    @@map("teams")
}

model OrganizationSettings {
    id                       String  @id @default(uuid())
    organization             Team    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    organizationId           String  @unique
    isOrganizationConfigured Boolean @default(false)
    isOrganizationVerified   Boolean @default(false)
    orgAutoAcceptEmail       String

    @@map("organization_settings")
}

model StripeProduct {
    id          String  @id
    priceId     String?
    name        String
    description String?
    isActive    Boolean
    isLive      Boolean // is this product live on stripe?
    metadata    Json?

    // those comes from stripe
    createdAt DateTime
    updatedAt DateTime

    features String[]

    @@map("stripe_products")
}

model Account {
    id                String  @id @default(uuid())
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId String

    @@unique([provider, providerAccountId])
    @@index([userId])
    @@index([type])
    @@map("accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    expires      DateTime

    user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId String

    @@index([userId])
    @@map("sessions")
}
