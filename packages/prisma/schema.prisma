generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["fullTextSearch"]
}

// generator zod {
//     provider      = "zod-prisma"
//     output        = "./zod"
//     imports       = "./zod-utils"
//     relationModel = "default"
// }

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator enums {
    provider = "tsx ./enum-generator"
}

enum AuthProvider {
    JWT
    GOOGLE
    FACEBOOK
}

enum Locale {
    fr
    en
}

model User {
    id            String    @id @default(uuid())
    firstName     String?
    lastName      String?
    fullName      String?
    avatarUrl     String?
    avatarColor   String?
    email         String    @unique
    password      String?
    locale        Locale?   @default(en)
    isRoot        Boolean   @default(false)
    /// @zod.custom(imports.userMetadata)
    metadata      Json?
    emailVerified DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    authProvider   AuthProvider @default(JWT)
    authProviderId String?

    teams    Membership[]
    accounts Account[]
    contacts Contact[]

    @@index([email, password])
    @@map("users")
}

model VerificationToken {
    id            Int      @id @default(autoincrement())
    identifier    String
    token         String   @unique
    expires       DateTime
    expiresInDays Int?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    team   Team?   @relation(fields: [teamId], references: [id])
    teamId String?

    @@unique([identifier, token])
    @@index([token])
    @@index([teamId])
    @@map("verification_tokens")
}

enum MembershipRole {
    MEMBER
    ADMIN
    OWNER
}

model Membership {
    id       String         @id @default(uuid())
    role     MembershipRole @default(MEMBER)
    accepted Boolean        @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
    teamId String

    @@unique([userId, teamId])
    @@index([userId])
    @@index([teamId])
    @@map("memberships")
}

model Team {
    id         String  @id @default(uuid())
    name       String
    slug       String  @unique
    websiteUrl String?
    logoUrl    String?
    /// @zod.custom(imports.teamMetadataSchema)
    metadata   Json?
    color      String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    members            Membership[]
    orgSettings        OrganizationSettings?
    verificationTokens VerificationToken[]
    studio             StudioDetails?
    contacts           Contact[]

    @@map("teams")
}

model OrganizationSettings {
    id                       String  @id @default(uuid())
    organization             Team    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    organizationId           String  @unique
    isOrganizationConfigured Boolean @default(false)
    isOrganizationVerified   Boolean @default(false)
    orgAutoAcceptEmail       String

    @@map("organization_settings")
}

model Account {
    id                String  @id @default(uuid())
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId String

    @@unique([provider, providerAccountId])
    @@index([userId])
    @@index([type])
    @@map("accounts")
}

model StripeProduct {
    id          String  @id
    priceId     String?
    name        String
    description String?
    isActive    Boolean
    isLive      Boolean // is this product live on stripe?
    metadata    Json?

    // those comes from stripe
    createdAt DateTime
    updatedAt DateTime

    features String[]

    @@map("stripe_products")
}

enum FeatureType {
    RELEASE
    EXPERIMENT
    OPERATIONAL
    KILL_SWITCH
    PERMISSION
}

model Feature {
    // The feature slug, ex: 'v2-workflows'
    slug        String       @id @unique
    // If the feature is currently enabled
    enabled     Boolean      @default(false)
    // A short description of the feature
    description String?
    // The type of feature flag
    type        FeatureType? @default(RELEASE)
    // If the flag is considered stale
    stale       Boolean?     @default(false)
    lastUsedAt  DateTime?
    createdAt   DateTime?    @default(now())
    updatedAt   DateTime?    @default(now()) @updatedAt
    updatedBy   String?

    @@index([enabled])
    @@index([stale])
    @@map("features")
}

model Address {
    id          String  @id @default(uuid())
    number      String?
    street      String?
    city        String
    postalCode  String
    country     String
    coordinates Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    studio   StudioDetails @relation(fields: [studioId], references: [id], onDelete: Cascade)
    studioId String        @unique

    @@map("addresses")
}

model Picture {
    id    String @id @default(uuid())
    url   String
    order Int?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    studio   StudioDetails @relation(fields: [studioId], references: [id], onDelete: Cascade)
    studioId String

    @@map("pictures")
}

model Service {
    id          String  @id @default(uuid())
    name        String
    description String?
    price       Float?
    duration    Int?
    isActive    Boolean

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    studio   StudioDetails @relation(fields: [studioId], references: [id], onDelete: Cascade)
    studioId String

    @@map("services")
}

enum Visibility {
    PUBLIC
    PRIVATE
}

model StudioDetails {
    id                 String   @id @default(uuid())
    description        Json
    minBookingDuration Float?
    amenities          String[]
    equipment          String[]

    address    Address?
    pictures   Picture[]
    services   Service[]
    visibility Visibility @default(PRIVATE)

    team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
    teamId String @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("studio_details")
}

enum ContactType {
    ARTIST
    GROUP
    LABEL
    MANAGER
    COMPANY
}

model Contact {
    id    String  @id @default(uuid())
    name  String
    email String
    phone String?

    type ContactType

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
    teamId String

    user   User   @relation(fields: [userId], references: [id])
    userId String

    @@unique([teamId, userId])
    @@map("contacts")
}
